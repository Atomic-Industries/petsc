<!DOCTYPE html>
<html>
  <head>
    <title>PETSc Finite Element Viewer</title>
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
    <script>

      function saws_to_plain_json(saws_json) {
              var plain = {};
              if (typeof saws_json.directories != "undefined") {
                      for (const key in saws_json.directories) {
                              plain[key] = saws_to_plain_json(saws_json.directories[key]);
                            }
                    }
              if (typeof saws_json.variables != "undefined") {
                      for (const key in saws_json.variables) {
                              plain[key] = saws_json.variables[key].data;
                            }
                    }
              return plain;
            }

      const plot_fe = (fe_saws_json) => {
              try {
                      const data = saws_to_plain_json(fe_saws_json).PetscFEPlotly;
                      number_of_elements = data.number_of_elements[0];
                      console.log("Plotting " + number_of_elements + " finite elements");
                      tabs_div = document.getElementById('feplotly_tabs');
                      for (let i = 0; i < number_of_elements; i++) {
                              tabs_div.innerHTML += '<button class="feplotly_tab"' + 'id="feplotly_tab_' + i + '" onclick="open_tab(event)"/><h3>' + i + '</h3></button>'
                            }
                      if (number_of_elements > 0) {
                              document.getElementById('feplotly_tab_0').click();
                            }
                      plot_div = document.getElementById('feplotly_plot');
                      Plotly.newPlot( plot_div, [{
                              x: [1, 2, 3, 4, 5],
                              y: [1, 2, 4, 8, 16] }], {
                                      margin: { t: 0 } } );
                    }
              catch (e) {
                      console.log(e);
                      document.getElementById('feplotly_status').innerHTML = "PetscFEPlotly error, see console log";
                    }
            };

      function open_tab(evt) {
              var tabs = document.getElementsByClassName("feplotly_tab");
              for (i = 0; i < tabs.length; i++) {
                      tabs[i].className = tabs[i].className.replace(" active", "");
                    }
              evt.currentTarget.className += " active";
            }

      const no_fe_network_error = (err) => {
              console.log(err);
              document.getElementById('feplotly_status').innerHTML = `
        <div style="error">
          <h2>Connection error</h2>

          <p>The SAWs server could not be reached.</p>

          <p>If you are running PETSc locally, do not try to load this webpage
             from <code>file://.../feplotly/</code>, use <code>http://localhost:&lt;port&gt;/feplotly/</code>.
             The default port is 8080, but may have been set with the command line
             option <code>-saws_port YYYY</code>.</p>
        </div>
     `;
            };
      const no_fe_json_error = (err) => {
              console.log(err);
              document.getElementById('feplotly_status').innerHTML = `
        <div style="error">
          <h2>Loading error</h2>

          <p>The finite element data could not be loaded.</p>

          <p>Your program may not have viewed any finite elements with the appropriate viewer.
             If your finite elements are created by <code>PetscFECreateDefault()</code> or
             <code>PetscFECreateLagrange()</code>, rerun your program with
             <code>-&lt;prefix&gt;petscfe_view saws::feplotly</code>,
             where <code>&lt;prefix&gt;</code> is the options prefix for your finite element.</p>
        </div>
     `;
            };
      window.onload = () => {
              const f = fetch('/SAWs/PETSc/Objects/PetscFEPlotly/')
                .then(result => result.json()
                        .then(data => plot_fe(data))
                        .catch(err => no_fe_json_error(err))
                      )
                .catch(err => no_fe_network_error(err))
            };
    </script>
    <style>
      html {
        font-family:sans-serif;
      }
      .feplotly_tabs {
        overflow: hidden;
        border: 1px;
      }
      .feplotly_tabs button {
        background-color: inherit;
        border: none;
        outline: none;
      }
      .feplotly_tabs button:hover {
        background-color: #ddd;
      }
      .feplotly_tabs button.active {
        background-color: #ccc;
      }
    </style>
    <link rel="icon" href="images/petsc_favicon.png"/>
  </head>

  <body>
    <header>
      <h1><a href="https://petsc.org"><img src="images/PETSc_RBG.svg" style="height:1em;"/></a> Finite Element Viewer</h1>
    </header>

    <div id="feplotly" class="feplotly">
      <div id="feplotly_status"></div>
      <div id="feplotly_tabs" class="feplotly_tabs"></div>
      <div id="feplotly_plot" style="width:600px;height:371px;"></div>
      <div id="feplotly_control_row">
        Degree of freedom: <select></select>
        Reference cell: <input type="checkbox"/>
        Dual functional: <input type="checkbox"/>
        Shape function: <input type="checkbox"/>
      </div>
    </div>

    <footer>
      <p>&copy; Copyright UChicago Argonne, LLC and the PETSc Development Team.</p>
    </footer>
  </body>
</html>
