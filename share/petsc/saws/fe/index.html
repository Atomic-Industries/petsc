<!DOCTYPE html>
<html>
  <head>
    <title>PETSc Finite Element Viewer</title>
    <script src="https://cdn.plot.ly/plotly-2.12.1.min.js"></script>
    <script>

      var fe_data = {};

      function saws_to_plain_json(saws_json) {
              let plain = {};
              if (typeof saws_json.directories != "undefined") {
                      for (const key in saws_json.directories) {
                              plain[key] = saws_to_plain_json(saws_json.directories[key]);
                            }
                    }
              if (typeof saws_json.variables != "undefined") {
                      for (const key in saws_json.variables) {
                              const is_char_array = (v) => ((typeof v === 'string') && v.length == 1);
                              if (saws_json.variables[key].data.every(is_char_array)) {
                                      plain[key] = saws_json.variables[key].data.join("");
                                    }
                              else {
                                      plain[key] = saws_json.variables[key].data;
                                    }
                            }
                    }
              return plain;
            }

      const plot_fe = (fe_saws_json) => {
              try {
                      fe_data = saws_to_plain_json(fe_saws_json).FE;
                      const number_of_elements = fe_data.number_of_elements[0];
                      console.log("Plotting " + number_of_elements + " finite elements");
                      const tabs_div = document.getElementById('feviewer_tabs');
                      for (let i = 0; i < number_of_elements; i++) {
                              if (fe_data[i].options_prefix != "") {
                                      tabs_div.innerHTML += '<button class="feviewer_tab"' + 'id="feviewer_tab_' + i + '" onclick="open_tab(event,' + i + ')"/><h3>' + fe_data[i].name.toString() + ' (' + fe_data[i].options_prefix.toString() + ')</h3></button>';
                                    }
                               else {
                                      tabs_div.innerHTML += '<button class="feviewer_tab"' + 'id="feviewer_tab_' + i + '" onclick="open_tab(event,' + i + ')"/><h3>' + fe_data[i].name + '</h3></button>';
                                     }
                            }
                      if (number_of_elements > 0) {
                              document.getElementById('feviewer_tab_0').click();
                            }
                      const plot_div = document.getElementById('feplotly_plot');
                      Plotly.newPlot( plot_div, [{
                              x: [1, 2, 3, 4, 5],
                              y: [1, 2, 4, 8, 16] }], {
                                      margin: { t: 0 } } );
                    }
              catch (e) {
                      console.log(e);
                      document.getElementById('feviewer_status').innerHTML = "FE error, see console log";
                    }
            };

      function open_tab(evt, j) {
              let tabs = document.getElementsByClassName("feviewer_tab");
              let this_fe = fe_data[j];
              for (let i = 0; i < tabs.length; i++) {
                      tabs[i].className = tabs[i].className.replace(" active", "");
                    }
              evt.currentTarget.className += " active";
              document.getElementById("fe_name").innerHTML = this_fe.name;
              if (this_fe.options_prefix != "") {
                      document.getElementById("fe_prefix").innerHTML = '<code>-' + this_fe.options_prefix + '</code>';
                    }
              else {
                      document.getElementById("fe_prefix").innerHTML = "&nbsp;";
                    }
              document.getElementById("fe_spatial_dimension").innerHTML = this_fe.spatial_dimension;
              document.getElementById("fe_dimension").innerHTML = this_fe.dimension;
              document.getElementById("fe_refel").innerHTML = this_fe.reference_element.polytope;
            }

      const no_fe_network_error = (err) => {
              console.log(err);
              document.getElementById('feviewer_status').innerHTML = `
        <div style="error">
          <h2>Connection error</h2>

          <p>The SAWs server could not be reached.</p>

          <p>If you are running PETSc locally, do not try to load this webpage
             from <code>file://.../fe/</code>, use <code>http://localhost:&lt;port&gt;/fe/</code>.
             The default port is 8080, but may have been set with the command line
             option <code>-saws_port YYYY</code>.</p>
        </div>
     `;
            };

      const no_fe_json_error = (err) => {
              console.log(err);
              document.getElementById('feviewer_status').innerHTML = `
        <div style="error">
          <h2>Loading error</h2>

          <p>The finite element data could not be loaded.</p>

          <p>Your program may not have viewed any finite elements with the appropriate viewer.
             If your finite elements are created by <code>PetscFECreateDefault()</code> or
             <code>PetscFECreateLagrange()</code>, rerun your program with
             <code>-&lt;prefix&gt;petscfe_view saws:</code>,
             where <code>&lt;prefix&gt;</code> is the options prefix for your finite element.</p>
        </div>
     `;
            };

      window.onload = () => {
              const f = fetch('/SAWs/PETSc/FE/')
                .then(result => result.json()
                        .then(data => plot_fe(data))
                        .catch(err => no_fe_json_error(err))
                      )
                .catch(err => no_fe_network_error(err))
            };
    </script>
    <style>
      html {
        font-family:sans-serif;
      }
      .feviewer_tabs {
        overflow: hidden;
        border: 1px;
      }
      .feviewer_main {
        display: table-row;
      }
      .feviewer_properties {
        width: 50%;
        display: table-cell;
      }
      .feviewer_properties dl {
        width: 100%;
        overflow: hidden;
        padding: 0;
        margin: 0;
      }
      .feviewer_properties dt {
        font-weight: bold;
        width: 50%;
        float: left;
        padding: 0;
        margin: 0;
      }
      .feviewer_properties dd {
        width: 50%;
        float: left;
        padding: 0;
        margin: 0;
      }
      .feplotly {
        width: 50%;
        display: table-cell;
      }
      .feplotly_plot {
        width: 600px;
        height: 371px;
      }
      .feviewer_tabs button {
        background-color: inherit;
        border: none;
        outline: none;
      }
      .feviewer_tabs button:hover {
        background-color: #ddd;
      }
      .feviewer_tabs button.active {
        background-color: #ccc;
      }
    </style>
    <link rel="icon" href="images/petsc_favicon.png"/>
  </head>

  <body>
    <header>
      <h1><a href="https://petsc.org"><img src="images/PETSc_RBG.svg" style="height:1em;"/></a> Finite Element Viewer</h1>
    </header>

    <div id="feviewer" class="feviewer">
      <div id="feviewer_status"></div>
      <div id="feviewer_tabs" class="feviewer_tabs"></div>
      <div id="feviewer_main" class="feviewer_main">
        <div id="feviewer_properties" class="feviewer_properties">
          <dl>
            <dt>name</dt><dd id="fe_name"></dd>
            <dt>options prefix</dt><dd id="fe_prefix"></dd>
            <dt>spatial dimension</dt><dd id="fe_spatial_dimension"></dd>
            <dt>number of basis functions</dt><dd id="fe_dimension"></dd>
            <dt>reference element</dt><dd id="fe_refel"></dd>
        </div>
        <div id="feplotly" class="feplotly">
          <div id="feplotly_control_row">
            Degree of freedom: <select></select>
            Reference cell: <input type="checkbox"/>
            Dual functional: <input type="checkbox"/>
            Shape function: <input type="checkbox"/>
          </div>
          <div id="feplotly_plot"></div>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; Copyright UChicago Argonne, LLC and the PETSc Development Team.</p>
    </footer>
  </body>
</html>
