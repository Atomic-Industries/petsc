#! /bin/csh
# 
# Compiles and tests PETSc in our nightly builds.
#
#
# Define some variables so that the table is concise.
#
#set TMP=/tmp/petsc
set SP=/sphome/petsc/petsc
set CCST=/ccsthome/petsc/petsc
set PETSC=/home/petsc/petsc
set LOIS=/home/curfman/petsc
set BALAY=/home/balay/petsc
#
#  load the machine names and versions to test
#
set day=`date | cut -f1 -d" "`
if ($day == Sun) then
  set M =(snake  maverick   cyan       elvis         clyde       ptera        maverick   quad        caffeine   )
  set B =(O      O_complex  g          g_c++         O_c++       Opg          O          O_c++       g          )
  set A =(hpux   sun4       IRIX       freebsd       rs6000      alpha        sun4_uni   rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared       shared     shared      shared     )
  set J1=(1      1          1          1             1           1            4          4           2          )
  set J2=(0      2          2          2             2           2            9          9           3          )
  set J3=(0      3          3          3             3           3            0          0           6          )
  set J4=(0      5          6          6             6           8            0          0           7          )
  set J5=(0      10         7          8             8           0            0          0           8          )
  set J6=(0      0          8          0             0           0            0          0           1          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    $SP         $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif
if ($day == Mon) then
  set M =(snake  maverick   cyan       elvis         doc         ptera       maverick    quad        caffeine   )
  set B =(g      Opg_c++    O_c++      g             O           g_c++       Opg         O           Opg_complex)
  set A =(hpux   sun4       IRIX       freebsd       rs6000_p4   alpha_nolog sun4        rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      noshared    shared      shared     )
  set J1=(0      1          1          1             1           1           1           1           1          )
  set J2=(1      2          2          2             2           2           2           2           2          )
  set J3=(0      8          3          3             3           3           3           3           3          )
  set J4=(0      0          6          6             6           6           7           6           5          )
  set J5=(0      0          8          7             7           8           8           7           10         )
  set J6=(0      0          0          8             8           0           0           8           0          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    /tmp/petsc  $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif  
if ($day == Tue) then
  set M =(snake  maverick   cyan       elvis         doc         ptera       maverick    quad        caffeine   )
  set B =(O      g          O_complex  O             g           O           Opg_c++     g           O_c++      )
  set A =(hpux   sun4       IRIX       freebsd       rs6000_p4   alpha       sun4        rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      noshared    shared      shared     )
  set J1=(0      1          1          1             1           1           1           1           1          )
  set J2=(2      2          2          2             2           2           2           2           2          )
  set J3=(0      3          3          3             3           3           3           3           3          )
  set J4=(6      6          5          6             6           6           8           6           6          )
  set J5=(0      7          10         7             7           7           0           7           8          )
  set J6=(0      8          0          8             8           8           0           8           0          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    /tmp/petsc  $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif
if ($day == Wed) then
  set M =(snake  maverick   cyan       elvis         clyde       ptera       maverick    quad        caffeine   )
  set B =(g      g_c++      Opg        g_complex     Opg_complex O_c++       Opg_c++     Opg_complex O          )
  set A =(hpux   sun4       IRIX       freebsd       rs6000      alpha       sun4_uni    rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      noshared    shared      shared     )
  set J1=(3      1          1          1             1           1           4           1           1          )
  set J2=(0      2          3          2             2           2           9           2           2          )
  set J3=(0      3          6          3             3           3           0           3           3          )
  set J4=(6      6          7          5             5           6           0           5           6          )
  set J5=(0      8          0          10            10          8           0           10          7          )
  set J6=(0      0          0          0             0           0           0           0           8          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    $SP         $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif
if ($day == Thu) then
  set M =(snake  maverick   cyan       elvis         clyde       ptera       maverick    quad        caffeine   )
  set B =(O      g_complex  g_c++      O_c++         g_c++       O_complex   Opg_complex g_c++       g          )
  set A =(hpux   sun4       IRIX       freebsd       rs6000      alpha       sun4        rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      noshared    shared      shared     )
  set J1=(0      1          1          1             1           1           1           1           1          )
  set J2=(0      2          2          2             2           2           2           2           2          )
  set J3=(3      3          3          3             3           3           3           3           3          )
  set J4=(6      5          6          6             6           5           5           6           6          )
  set J5=(0      10         8          8             8           10          10          8           7          )
  set J6=(0      0          0          0             0           0           0           0           8          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    $SP         $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif  
if ($day == Fri) then
  set M =(snake  maverick   cyan       elvis         clyde       ptera       maverick    quad        caffeine   )
  set B =(g      O_c++      g_complex  O_complex     g_complex   g_complex   Opg         g_complex   g_c++      )
  set A =(hpux   sun4       IRIX       freebsd       rs6000      alpha       sun4        rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      noshared    shared      shared     )
  set J1=(0      1          1          1             1           1           1           1           1          )
  set J2=(2      2          2          2             2           2           2           2           2          )
  set J3=(0      3          3          3             3           3           3           3           3          )
  set J4=(6      6          5          5             5           5           7           5           6          )
  set J5=(0      8          10         10            10          10          8           10          8          )
  set J6=(0      0          0          0             0           0           0           0           0          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    $SP         $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif
if ($day == Sat) then
  set M =(snake  maverick   cyan       elvis         doc         ptera       maverick    quad        caffeine   )
  set B =(O      O          O          Opg_complex   O           Opg_c++     g_complex   Opg         O_complex  )
  set A =(hpux   sun4       IRIX       freebsd       rs6000_p4   alpha       sun4_uni    rs6000_quad solaris    )
  set S =(shared noshared   shared     noshared      noshared    shared      shared      shared      shared     )
  set J1=(1      1          1          1             1           1           4           1           1          )
  set J2=(0      2          2          2             2           2           9           2           2          )
  set J3=(0      3          3          3             3           3           5           3           3          )
  set J4=(6      6          6          5             6           6           10          7           5          )
  set J5=(0      7          7          10            7           7           0           8           10         )
  set J6=(0      8          8          0             8           8           0           0           4          )
  set H=($PETSC  /tmp/petsc /tmp/petsc /tmp/petsc    /tmp/petsc  $LOIS       /tmp/petsc  $CCST       $BALAY     )
endif
#
#  test for each machine
#
foreach job ($*)
  set mach    = $M[$job]
  set bopt    = $B[$job]
  set arch    = $A[$job]
  set shar    = $S[$job]
  set job1    = $J1[$job]
  set job2    = $J2[$job]
  set job3    = $J3[$job]
  set job4    = $J4[$job]
  set job5    = $J5[$job]
  set job6    = $J6[$job]
  set hme     = $H[$job]

#
# On quad and clyde do not run the test examples
#
  if ( $mach == clyde || $mach == quad ) then 
    set TEST = buildexamples_
  else
    set TEST = testexamples_
  endif

  rsh $mach -n /home/bsmith/petsc/maint/buildlinks $hme > /dev/null
  rsh $mach -n "cd $hme/maint ;rm -f build_$arch.$bopt.$mach.log examples_$arch.$bopt.$mach.log"

  rsh $mach -n "cd $hme ; echo 'Build on $mach $arch $bopt `date` ' > maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt all $shar >>& maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ; echo '****************************************************' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt fortran >>& maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme; chmod -R g+w lib" >& /dev/null
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach  $arch $bopt `date`' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;echo 'Build on $mach  $bopt `date` ' > maint/examples_$arch.$bopt.$mach.log"
  if ( $job1 != 0 ) then 
    rsh $mach -n "cd $hme ;   make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job1 tree >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job2 != 0 ) then 
    rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job2 tree  >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job3 != 0 ) then 
    rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job3 tree  >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job4 != 0 ) then 
    rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job4 tree  >>& maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job5 != 0 ) then 
    rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job5 tree  >>& maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job6 != 0 ) then 
    rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job6 tree  >>& maint/examples_$arch.$bopt.$mach.log"
  endif
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach $arch $bopt `date`' >> maint/examples_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ; echo 'Finished Build `date`' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;echo 'Finished Build `date`' >> maint/examples_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;/bin/cp  maint/examples_$arch.$bopt.$mach.log /home/bsmith/petsc/maint/nightlylogs"
  rsh $mach -n "cd $hme ;/bin/cp  maint/build_$arch.$bopt.$mach.log /home/bsmith/petsc/maint/nightlylogs"
end

