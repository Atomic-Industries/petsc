#! /bin/csh
# 
# Compiles and tests PETSc in our nightly builds.
#
#
#  load the machine names and versions to test
#
set day=`date | cut -f1 -d" "`
if ($day == Sun) then
  set M =(snake            eagle      ryan              elvis         doc         ptera               maverick   )
  set B =(O                O_complex  g                 g_c++         O_c++       Opg                 O          )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha               sun4_uni   )
  set J1=(1                1          1                 1             1           1                   4          )
  set J2=(0                2          2                 2             2           2                   3          )
  set J3=(0                3          3                 3             3           3                   0          )
  set J4=(0                0          6                 6             6           0                   0          )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc /tmp/petsc )
endif
if ($day == Mon) then
  set M =(snake            eagle      puck              elvis         doc         ptera                maverick    )
  set B =(g                Opg_c++    O_c++             g             O           g                    Opg         )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha_nolog          sun4_local  )
  set J1=(0                1          1                 1             1           1                    1           )
  set J2=(1                2          2                 2             2           2                    2           )
  set J3=(0                3          3                 3             3           3                    3           )
  set J4=(0                6          6                 6             6           6                    0           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc  /tmp/petsc  )
endif  
if ($day == Tue) then
  set M =(snake            eagle      puck              elvis         doc         ptera                maverick    )
  set B =(O                g          O_complex         O             g           O                    Opg_c++     )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha                sun4_local  )
  set J1=(0                1          1                 1             1           1                    1           )
  set J2=(2                2          2                 2             2           2                    2           )
  set J3=(0                3          3                 3             3           3                    3           )
  set J4=(6                6          0                 6             6           6                    0           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc  /tmp/petsc  )
endif
if ($day == Wed) then
  set M =(snake            eagle      ryan              elvis         doc         ptera                maverick    )
  set B =(g                g_c++      Opg               O_complex     Opg_complex g                    Opg_c++     )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha_nolog          sun4_uni    )
  set J1=(3                1          1                 1             1           1                    4           )
  set J2=(0                2          2                 2             2           2                    3           )
  set J3=(0                3          3                 3             3           3                    0           )
  set J4=(6                6          6                 0             0           6                    0           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc  /tmp/petsc  )
endif
if ($day == Thu) then
  set M =(snake            eagle      puck              elvis         doc         ptera                maverick    )
  set B =(Opg              g_complex  g_c++             O_c++         g_c++       g                    Opg_complex )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha                sun4_local  )
  set J1=(0                1          1                 1             1           1                    6           )
  set J2=(0                2          2                 2             2           2                    0           )
  set J3=(3                3          3                 3             3           3                    0           )
  set J4=(6                0          6                 6             6           6                    0           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc  /tmp/petsc  )
endif
if ($day == Fri) then
  set M =(snake            eagle      puck              elvis         doc         ptera                maverick    )
  set B =(g                O_c++      g_complex         g_complex     g           Opg                  Opg         )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha                sun4_local  )
  set J1=(0                1          1                 1             1           1                    1           )
  set J2=(2                2          2                 2             2           2                    2           )
  set J3=(0                3          3                 3             3           3                    3           )
  set J4=(6                6          0                 0             6           0                    0           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc              )
endif
if ($day == Sat) then
  set M =(snake            eagle      ryan              elvis         doc         ptera                maverick    )
  set B =(O                O          O                 Opg_complex   g_complex   g                    g_complex   )
  set A =(hpux             sun4_local IRIX              freebsd_local rs6000_p4   alpha                sun4_uni    )
  set J1=(1                1          1                 1             1           1                    6           )
  set J2=(0                2          2                 2             2           2                    0           )
  set J3=(0                3          3                 3             3           3                    0           )
  set J4=(6                6          6                 0             0           6                    6           )
  set H=(/home/petsc/petsc /tmp/petsc /home/balay/petsc /tmp/petsc    /tmp/petsc  /home/curfman/petsc  /tmp/petsc  )
endif
#
#  test for each machine
#
foreach job ($*)
  set mach    = $M[$job]
  set bopt    = $B[$job]
  set arch    = $A[$job]
  set job1    = $J1[$job]
  set job2    = $J2[$job]
  set job3    = $J3[$job]
  set job4    = $J4[$job]
  set hme     = $H[$job]

  rsh $mach -n /home/bsmith/petsc/maint/buildlinks $hme > /dev/null
  rsh $mach -n "cd $hme/maint ;rm -f build_$arch.log examples_$arch.log"

  if ($mach == ptera) then
    set E = -e
  else
    set E = ""
  endif

  rsh $mach -n "cd $hme ; echo 'Build on $mach $bopt `date` ' > maint/build_$arch.log"
  rsh $mach -n "cd $hme ;  make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt all >>& maint/build_$arch.log"
  rsh $mach -n "cd $hme ; echo '****************************************************' >> maint/build_$arch.log"
  rsh $mach -n "cd $hme;  make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt fortran >>& maint/build_$arch.log"
  rsh $mach -n "cd $hme; chmod -R g+w lib" >& /dev/null
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach  $arch $bopt `date`' >> maint/build_$arch.log"
  rsh $mach -n "cd $hme ;echo 'Build on $mach  $bopt `date` ' > maint/examples_$arch.log"
  if ( $job1 != 0 ) then 
    rsh $mach -n "cd $hme ;   make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=testexamples_$job1 tree >>& maint/examples_$arch.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.log"
  endif
  if ( $job2 != 0 ) then 
    rsh $mach -n "cd $hme ;  make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=testexamples_$job2 tree  >>& maint/examples_$arch.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.log"
  endif
  if ( $job3 != 0 ) then 
    rsh $mach -n "cd $hme ;  make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=testexamples_$job3 tree  >>& maint/examples_$arch.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.log"
  endif
  if ( $job4 != 0 ) then 
    rsh $mach -n "cd $hme ;  make $E PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=testexamples_$job4 tree  >>& maint/examples_$arch.log"
  endif
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach $arch $bopt `date`' >> maint/examples_$arch.log"
  rsh $mach -n "cd $hme ; echo 'Finished Build `date`' >> maint/build_$arch.log"
  rsh $mach -n "cd $hme ;echo 'Finished Build `date`' >> maint/examples_$arch.log"
  rsh $mach -n "cd $hme ;/bin/cp -f maint/examples_$arch.log /home/bsmith/petsc/maint/nightlylogs"
  rsh $mach -n "cd $hme ;/bin/cp -f maint/build_$arch.log /home/bsmith/petsc/maint/nightlylogs"
end

