#! /bin/csh
# 
# Compiles and tests PETSc in our nightly builds.
#
# Assign jobs to each account
#
if ($1 == petsc) then
  set job = (1 2)
endif
if ($1 == bsmith) then 
  set job = (3)
endif
if ($1 == curfman) then 
  set job = (4)
endif
if ($1 == balay) then 
  set job = (5)
endif
#
#
setenv H /home/petsc/$1
cd $H/maint
/bin/rm -f build.log examples.log
#
#  load the machine names and versions to test
#
source /home/bsmith/petsc/maint/testmachines
#
#  test for each machine
#
foreach i ($job)
  set mach    = $M[$i]
  set bopt    = $B[$i]
  set arch    = $A[$i]
  echo "****************************************************" >> build.log
  echo "Build on $mach $bopt `date` " >> build.log
  rsh $mach -n "cd $H ; \
    make PETSC_ARCH=$arch PETSC_DIR=$H BOPT=$bopt all >>& maint/build.log"
  echo "****************************************************" >> build.log
  rsh $mach -n "cd $H; \
    make PETSC_ARCH=$arch PETSC_DIR=$H BOPT=$bopt fortran >>& maint/build.log"
  endif
  rsh $mach -n "cd $H; chmod -R g+w lib" >& /dev/null
  echo "Finished Build on $mach  $arch $bopt `date`" >> build.log
  echo "****************************************************">>examples.log
  echo "Build on $mach  $bopt `date` " >> examples.log
  rsh $mach -n "cd $H ;  \
    make PETSC_ARCH=$arch PETSC_DIR=$H BOPT=$bopt testexamples >>& maint/examples.log"
  echo "******************************************************" >> examples.log
  rsh $mach -n "cd $H ;  \
    make PETSC_ARCH=$arch PETSC_DIR=$H BOPT=$bopt ACTION=testexamples_2 tree >>& maint/examples.log"
  echo "******************************************************" >> examples.log
  rsh $mach -n "cd $H ;  \
    make PETSC_ARCH=$arch PETSC_DIR=$H BOPT=$bopt ACTION=testexamples_3 tree >>& maint/examples.log"
  endif
  echo "Finished Build on $mach $arch $bopt `date`" >> examples.log
  rsh $mach -n "cd $H ; \
    /bin/cp lib/lib$bopt/$arch/*.a /home/bsmith/petsc/lib/lib$bopt/$arch  >>& /dev/null ;\
  chmod g+w /home/bsmith/petsc/lib/lib$bopt/$arch ; \
  ranlib -t /home/bsmith/petsc/lib/lib$bopt/$arch/*.a  >>& /dev/null"
end
echo "Finished Build `date`" >> build.log
echo "Finished Build `date`" >> examples.log

echo "Errors from PETSc nightly build" > trashz
date >> trashz
cat build.log examples.log \
           | egrep -i 'error|warning|problem|failed|undefined' >> trashz
if ($status == 0) then
  echo "Errors generated in $H" > trash
  cat trashz >> trash
  /bin/mail balay < trash
else
  echo "No errors generated in $H -- hard to believe" > trash
  /bin/mail curfman < trash
endif 
/bin/rm -f trash trashz
chmod ug+w  build.log examples.log


