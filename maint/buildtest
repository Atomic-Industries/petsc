#! /bin/csh
# $Id: buildtest,v 1.123 1998/04/01 00:39:45 balay Exp balay $ 

# 
# Compiles and tests PETSc in our nightly builds.
#
#
# Define some variables so that the table is concise.
#
#set TMP=/tmp/petsc
set SP=/sphome/petsc/petsc
set CCST=/ccsthome/petsc/petsc
set PETSC=/home/petsc/petsc
set LOIS=/home/curfman/petsc
set BALAY=/home/balay/petsc
set TMP=/tmp/petsc
set TMP_S=/tmp/balay/petsc
set TMP_P=/tmp/petsc/petsc
set TMP_B=/tmp/bsmith/petsc
set TMP_C=/tmp/curfman/petsc
set SB_P=/sandbox/petsc/petsc
set SB_B=/sandbox/balay/petsc
#
#  load the machine names and versions to test
#
set day=`date | cut -f1 -d" "`
if ($day == Sun) then
  set M =(snake  fire       violet     flight        tri63       ptera        lava        quad        eagle       yukon       homer        )
  set B =(O      O_complex  g          g_c++         O_c++       Opg          O           O_c++       g           g_complex   g            ) 
  set A =(hpux   solaris    IRIX       linux         rs6000_p4   alpha        solaris_uni rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared shared     shared     shared        noshared    shared       shared      shared      shared      shared      noshared     )
  set J1=(1      1          1          1             1           1            4           4           2           1           1            )
  set J2=(0      2          2          2             2           2            9           9           3           2           2            )
  set J3=(0      3          3          3             3           3            0           0           6           3           3            )
  set J4=(0      5          6          6             6           7            0           0           7           5           6            )
  set J5=(0      10         7          8             8           8            0           0           8           10          7            )
  set J6=(0      0          8          0             0           0            0           0           1           0           8            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY        $TMP_P      $LOIS        $SB_P       $CCST       $SB_B       $SB_P       $TMP_P       )
endif
if ($day == Mon) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(g      Opg_c++    O_c++      g             O           g           Opg          O           Opg_complex O_complex   O_c++        )
  set A =(hpux   solaris    IRIX       linux         rs6000_p4   alpha_nolog solaris      rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared noshared   shared     shared        noshared    shared      noshared     shared      shared      shared      nonshared    )
  set J1=(0      1          1          1             1           1           1            1           1           1           1            )
  set J2=(1      2          2          2             2           2           2            2           2           2           2            )
  set J3=(0      8          3          3             3           6           3            3           3           3           3            )
  set J4=(0      0          6          6             6           7           7            6           5           5           6            )
  set J5=(0      0          8          7             8           3           8            7           10          10          8            )
  set J6=(0      0          0          8             0           8           0            8           0           0           0            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY        $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif  
if ($day == Tue) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(O      g          O_complex  O             g           O           Opg_c++      g           O_c++       g_c++       O_complex    )
  set A =(hpux   solaris    IRIX       linux         rs6000_p4   alpha       solaris      rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared noshared   shared     shared        noshared    shared      noshared     shared      shared      shared      noshared     )
  set J1=(0      1          1          1             1           1           1            1           1           1           1            )
  set J2=(2      2          2          2             2           2           2            2           2           2           2            )
  set J3=(0      3          3          3             3           6           3            3           3           3           3            )
  set J4=(6      6          5          6             6           7           8            6           6           6           6            )
  set J5=(0      7          10         7             8           3           0            7           8           8           7            )
  set J6=(0      8          0          8             0           8           0            8           0           0           8            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY        $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif
if ($day == Wed) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(g      g_c++      O          g_complex     Opg_complex Opg         Opg_c++      Opg_complex O           g           O            )
  set A =(hpux   solaris    IRIX       linux         rs6000_p4   alpha_uni   solaris_uni  rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared shared     shared     shared        noshared    shared      noshared     shared      shared      shared      noshared     )
  set J1=(3      1          1          1             1           4           4            1           1           1           1            )
  set J2=(0      2          2          2             2           9           9            2           2           2           2            )
  set J3=(0      3          3          3             3           0           0            3           3           3           3            )
  set J4=(6      6          6          5             5           0           0            5           6           4           6            )
  set J5=(0      8          7          10            10          0           0            10          7           7           7            )
  set J6=(0      0          8          0             0           0           0            0           8           8           8            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY        $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif
if ($day == Thu) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(O      g_complex  g_c++      O_c++         Opg         g           Opg_complex  g_c++       g           O           g_c++        )
  set A =(hpux   solaris    IRIX       linux         rs6000_gnu  alpha       solaris      rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared shared     shared     shared        noshared    shared      noshared     shared      shared      shared      noshared     )
  set J1=(0      1          1          1             1           1           1            1           1           1           1            )
  set J2=(0      2          2          2             2           2           2            2           2           2           2            )
  set J3=(3      3          3          3             3           6           3            3           3           3           3            )
  set J4=(6      5          6          6             6           7           5            6           6           6           6            )
  set J5=(0      10         8          8             8           3           10           8           7           7           8            )
  set J6=(0      0          0          0             0           8           0            0           8           8           0            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY       $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif  
if ($day == Fri) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(g      O_c++      g_complex  O_complex     g           O           Opg          g_complex   g_c++       O           g            )
  set A =(hpux   solaris    IRIX       linux         rs6000_gnu  alpha_uni   solaris      rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared shared     shared     shared        noshared    shared      noshared     shared      shared      shared      noshared     )
  set J1=(0      1          1          1             1           4           1            1           1           1           1            )
  set J2=(2      2          2          2             2           9           2            2           2           2           2            )
  set J3=(0      3          3          3             3           0           3            3           3           3           3            )
  set J4=(6      6          5          5             5           0           7            5           6           6           6            )
  set J5=(0      8          10         10            10          0           8            10          8           7           7            )
  set J6=(0      0          0          0             0           0           0            0           0           8           8            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY       $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif
if ($day == Sat) then
  set M =(snake  fire       violet     flight        tri63       ptera       lava         quad        eagle       yukon       homer        )
  set B =(O      O          O          Opg_complex   O           Opg         g_complex    Opg         O_complex   O_c++       Opg          )
  set A =(hpux   solaris    IRIX       linux         rs6000_gnu  alpha_nolog solaris_uni  rs6000      sun4        IRIX64      freebsd_egcs )
  set S =(shared shared     shared     shared        noshared    shared      shared       shared      shared      shared      noshared     )
  set J1=(1      1          1          1             1           1           4            1           1           1           1            )
  set J2=(0      2          2          2             2           2           9            2           2           2           2            )
  set J3=(0      3          3          3             3           6           11           3           3           3           6            )
  set J4=(6      6          6          5             6           7           10           7           5           6           7            )
  set J5=(0      7          7          10            8           3           0            8           10          8           3            )
  set J6=(0      8          8          0             0           8           0            0           4           0           8            )
  set H=($PETSC  $TMP_S     $TMP_P     $BALAY       $TMP_P      $LOIS       $SB_P        $CCST       $SB_B       $SB_P       $TMP_P       )
endif
#
#  test for each machine
#
foreach job ($*)
  set mach    = $M[$job]
  set bopt    = $B[$job]
  set arch    = $A[$job]
  set shar    = $S[$job]
  set job1    = $J1[$job]
  set job2    = $J2[$job]
  set job3    = $J3[$job]
  set job4    = $J4[$job]
  set job5    = $J5[$job]
  set job6    = $J6[$job]
  set hme     = $H[$job]

#
# On quad and clyde do not run the test examples
#
  if ( $mach == clyde || $mach == quad ) then 
    set TEST = buildexamples_
  else
    set TEST = testexamples_
  endif

  rsh $mach -n /home/bsmith/petsc/maint/buildlinks $hme >& /dev/null
  rsh $mach -n "cd $hme/maint ;rm -f build_$arch.$bopt.$mach.log examples_$arch.$bopt.$mach.log"

  rsh $mach -n "cd $hme ; echo 'Build on $mach $arch $bopt `date` ' > maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;  make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt all $shar >>& maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ; echo '****************************************************' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme; chmod -R g+w lib" >& /dev/null
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach  $arch $bopt `date`' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;echo 'Build on $mach $arch  $bopt `date` ' > maint/examples_$arch.$bopt.$mach.log"
  if ( $job1 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job1 tree >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job2 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job2 tree  >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job3 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job3 tree  >>& maint/examples_$arch.$bopt.$mach.log"
    rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job4 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job4 tree  >>& maint/examples_$arch.$bopt.$mach.log"
   rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job5 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job5 tree  >>& maint/examples_$arch.$bopt.$mach.log"
   rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  if ( $job6 != 0 ) then 
    rsh $mach -n "cd $hme ;  nice -20 make PETSC_ARCH=$arch PETSC_DIR=$hme BOPT=$bopt ACTION=$TEST$job6 tree  >>& maint/examples_$arch.$bopt.$mach.log"
   rsh $mach -n "cd $hme ; echo '******************************************************' >> maint/examples_$arch.$bopt.$mach.log"
  endif
  rsh $mach -n "cd $hme ;echo 'Finished Build on $mach $arch $bopt `date`' >> maint/examples_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ; echo 'Finished Build `date`' >> maint/build_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;echo 'Finished Build `date`' >> maint/examples_$arch.$bopt.$mach.log"
  rsh $mach -n "cd $hme ;/bin/cp  maint/examples_$arch.$bopt.$mach.log /home/bsmith/petsc/maint/nightlylogs"
  rsh $mach -n "cd $hme ;/bin/cp  maint/build_$arch.$bopt.$mach.log /home/bsmith/petsc/maint/nightlylogs"
end






