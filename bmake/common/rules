

LDIR     = $(ITOOLSDIR)/libs/libs$(BOPT)/$(ARCH)
LIBNAME  = $(LDIR)/$(LIBBASE).a
SOURCE   = $(SOURCEC) $(SOURCEF)
OBJS     = $(OBJSC) $(OBJSF)

include $(ITOOLSDIR)/bmake/$(PARCH).site
include $(ITOOLSDIR)/bmake/$(PARCH).$(BOPT)

$(LIBNAME)($(OBJS)): $(LINCLUDE)

examples: 
	@-if [ "$(EXAMPLES)" != "" ] ; then \
          (for ex in $(EXAMPLES) foo ; do \
          $(MAKE) -f makefile PARCH=$(PARCH) BOPT=$(BOPT) $$ex; done;) fi

runexamples: 
	@-if [ "$(EXAMPLES)" != "" ] ; then \
          (for ex in $(EXAMPLES) echo ; do \
          $$ex; done;) fi

tests:
	@-if [ "$(TESTS)" != "" ] ; then \
	(for ex in $(TESTS) foo ; do \
	$(MAKE) -f makefile PARCH=$(PARCH) BOPT=$(BOPT) $$ex; done;) fi

runtests: 
	@-if [ "$(TESTS)" != "" ] ; then \
          (for ex in $(TESTS) echo ; do \
          $$ex; done;) fi

foo:

lib: $(SOURCE)
	@-if [ "$(SOURCEC)" != "" ] ; then \
           $(MAKE) -f makefile PARCH=$(PARCH) BOPT=$(BOPT) libc; fi
	@-if [ "$(SOURCEF)" != "" ] ; then \
           $(MAKE) -f makefile PARCH=$(PARCH) BOPT=$(BOPT) libf; fi
	@-if [ "$(OBJS)" != " " ] ; then \
        	$(RANLIB)  $(LIBNAME); \
        fi

libfast: $(SOURCEC) $(SOURCEF)
	@-if [ "$(SOURCEC)" != "" ] ; then \
	     $(CC) -c $(CFLAGS) $(BASEOPT) $(SOURCEC) ;\
	fi
	@-if [ "$(SOURCEF)" != "" ] ; then \
	     $(FC) -c $(FFLAGS) $(BASEOPTF) $(SOURCEF) ;\
	fi
	@-if [ "$(OBJS)" != " " ] ; then \
          $(AR) clq $(LIBNAME) $(OBJS); \
	  $(RM) $(OBJS); \
        fi

lint:
	lint -cvhu -DLINT $(CFLAGS) $(SOURCE)

C2f77:
	@-if [ -n "$(WOBJS)" ] ; then \
  	$(ITOOLSDIR)/c2f77/bfort -nomsgs -anyname -mapptr \
                         $(SOURCEC) $(SOURCEH); fi

C2f77lib: 
	@-if [ -n "$(WOBJS)" ] ; then \
	echo "Compiling wrappers: " $(WSOURCEC); \
	$(CC) -c $(CDEFS) $(CFLAGS) $(BASEOPT) -I$(ITOOLSDIR) $(WSOURCEC); \
	$(AR) clr $(LDIR)/libpetscfort.a $(WOBJS) ; \
	$(RM) $(WOBJS) $(WSOURCE); \
	fi

manpages:
	@-if [ "$(MANSEC)" != "" ] ; then \
	$(ITOOLSDIR)/doc/doctext -jumpfile $(ITOOLSDIR)/routine.list \
                -mpath $(ITOOLSDIR)/man/man$(MANSEC) -ext $(MANSEC)  \
                 $(SOURCEC) $(SOURCEH); fi 

clean:
	-/bin/rm -f *.o *~ $(CLEANFILES) $(WSOURCEC) $(EXAMPLES) $(TESTS)

#############
cleantree: clean 
	@-if [ "$(DIRS)" != "" ] ; then \
	for dir in $(DIRS) foo ; do if [ -s $$dir ] ; then \
	( cd $$dir ; echo Cleaning: $$dir ; $(MAKE) -f makefile cleantree ) ; \
        fi ; done ; fi

manpagestree: manpages
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo; do if [ -s $$dir ]; then \
        (cd $$dir ; echo "Making manpages in:" $$dir ; \
        $(MAKE) -f makefile BOPT=$(BOPT)\
        PARCH=$(PARCH) manpagestree) ;fi; \
        done ; fi

C2f77tree: C2f77
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Making wrappers in $$dir ; \
        $(MAKE) -f makefile BOPT=$(BOPT)\
        PARCH=$(PARCH) C2f77tree) ;fi; \
        done ; fi

C2f77libtree: C2f77lib
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Compiling wrappers in: $$dir ;\
        $(MAKE) -f makefile BOPT=$(BOPT)\
        PARCH=$(PARCH) C2f77libtree) ;fi; \
        done ; fi

libtree: lib
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo ; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Compiling in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
        PARCH=$(PARCH) libtree) ;fi; \
        done ; fi

libfasttree: libfast
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Compiling in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
        PARCH=$(PARCH) libfasttree) ;fi; \
        done ; fi

examplestree: examples
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo ; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Compiling examples in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
        PARCH=$(PARCH) examplestree) ;fi; \
        done ; fi

teststree: tests
	@-if [ "$(DIRS)" != "" ]; then \
	for dir in $(DIRS) foo ; do if [ -s $$dir ]; then \
	(cd $$dir ; echo Compiling tests in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
	PARCH=$(PARCH) teststree) ;fi; \
	done ; fi

runexamplestree: runexamples
	@-if [ "$(DIRS)" != "" ]; then \
        for dir in $(DIRS) foo ; do if [ -s $$dir ]; then \
        (cd $$dir ; echo Examples in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
        PARCH=$(PARCH) runexamplestree) ;fi; \
        done ; fi

runteststree: runtests
	@-if [ "$(DIRS)" != "" ]; then \
	for dir in $(DIRS) foo ; do if [ -s $$dir ]; then \
	(cd $$dir ; echo Tests in $$dir ; $(MAKE) -f makefile BOPT=$(BOPT) \
	PARCH=$(PARCH) runteststree) ;fi; \
	done ; fi

